---
root_group: >-
    {%- if ansible_system == 'Linux' and ansible_distribution == 'Ubuntu' -%}
      root
    {%- else -%}
      wheel
    {%- endif -%}
nginx:
  security_headers: []
  prefix:
    config: >-
      {%- if ansible_system == 'Linux' -%}
        /etc/nginx
      {%- else -%}
        /usr/local/etc/nginx
      {%- endif -%}
    log: /var/log/nginx
    modsecurity:
      config: "/usr/local/etc/modsecurity"
      log: /var/log/modsecurity
  worker_processes: 8
  user: "{{ 'www-data' if ansible_system == 'Linux' else 'www' }}"
  nameservers:
    - '[2606:4700:4700::1111]:53'
    - '[2606:4700:4700::1001]:53'
  nameservers_valid: 300s
  nameservers_ipv6: "on"
  server_names_hash_max_size:
  server_names_hash_bucket_size:
  dhparam_bits: 4096
  moved_permanently: {}
  redirects: {}
  real_ip_header: X-Real-IP
  set_real_ip_from: {}
  proxy_ssl_trusted_certificate: >-
    {%- if ansible_system == 'Linux' -%}
      /etc/ssl/certs/ca-certificates.crt
    {%- else -%}
      /usr/local/share/certs/ca-root-nss.crt
    {%- endif -%}
  hsts:
    max_age: 31536000
    include_subdomains: no
    preload: no
  log_format: main
  log_formats:
    json:
      fields:
        host: $host
        remote_addr: $remote_addr
        remote_user: $remote_user
        time_iso8601: $time_iso8601
        request_method: $request_method
        request_uri: $request_uri
        server_protocol: $server_protocol
        status: $status
        body_bytes_sent: $body_bytes_sent
        http_referer: $http_referer
        http_user_agent: $http_user_agent
        http_x_forwarded_for: $http_x_forwarded_for
        http_x_real_ip: $http_x_real_ip
        request_id: $request_id
        request_time: $request_time
        bytes_sent: $bytes_sent
        request_length: $request_length
        connection: $connection
        connection_requests: $connection_requests
        sent_http_content_type: $sent_http_content_type
        dnt: $dnt
  ansible_info:
    server_name:
    private_api:
  dynamic_modules_path: >-
      {%- if ansible_system == 'Linux' -%}
        /usr/lib/nginx/modules
      {%- else -%}
        /usr/local/libexec/nginx
      {%- endif -%}
  dynamic_modules:
    ngx_http_headers_more_filter_module.so: "{{ false if ansible_system == 'Linux' else true }}"
    ngx_http_modsecurity_module.so: "{{ true if vars.nginx.modsecurity.enabled else false }}"
    ngx_stream_module.so: false
  htpasswd: {}
  stub_status_port:
  modsecurity:
    enabled: true
    owasp_crs:
      enabled: true
      version: 3.3.5
    config:
      SecRuleEngine: DetectionOnly
      SecRequestBodyAccess: "On"
      SecRequestBodyLimit: 13107200
      SecRequestBodyNoFilesLimit: 131072
      SecRequestBodyLimitAction: Reject
      SecRequestBodyJsonDepthLimit: 512
      SecPcreMatchLimit: 1000
      SecPcreMatchLimitRecursion: 1000
      SecResponseBodyAccess: "On"
      SecResponseBodyMimeType: text/plain text/html text/xml
      SecResponseBodyLimit: 524288
      SecResponseBodyLimitAction: ProcessPartial
      SecTmpDir: /tmp/
      SecDataDir: /tmp/
      SecAuditEngine: RelevantOnly
      SecAuditLogRelevantStatus: "\"^(?:5|4(?!04))\""
      SecAuditLogParts: ABIJDFHZ
      SecAuditLogType: Serial
      SecAuditLog: "{{ vars.nginx.prefix.modsecurity.log }}/audit.log"
      SecArgumentSeparator: "&"
      SecCookieFormat: 0
      SecUnicodeMapFile: unicode.mapping 20127
      SecStatusEngine: "Off" # telemetry
      SecAuditLogFormat: json
    rules:
      xml_body_parser: |
        REQUEST_HEADERS:Content-Type "^(?:application(?:/soap\+|/)|text/)xml" \
        "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
      json_body_parser: |
        REQUEST_HEADERS:Content-Type "^application/json" \
        "id:'200001',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"
      reqbody_error: |
        REQBODY_ERROR "!@eq 0" \
        "id:'200002', phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"
      multipart_strict_error: |
        MULTIPART_STRICT_ERROR "!@eq 0" \
        "id:'200003',phase:2,t:none,log,deny,status:400, \
        msg:'Multipart request body failed strict validation: \
        PE %{REQBODY_PROCESSOR_ERROR}, \
        BQ %{MULTIPART_BOUNDARY_QUOTED}, \
        BW %{MULTIPART_BOUNDARY_WHITESPACE}, \
        DB %{MULTIPART_DATA_BEFORE}, \
        DA %{MULTIPART_DATA_AFTER}, \
        HF %{MULTIPART_HEADER_FOLDING}, \
        LF %{MULTIPART_LF_LINE}, \
        SM %{MULTIPART_MISSING_SEMICOLON}, \
        IQ %{MULTIPART_INVALID_QUOTING}, \
        IP %{MULTIPART_INVALID_PART}, \
        IH %{MULTIPART_INVALID_HEADER_FOLDING}, \
        FL %{MULTIPART_FILE_LIMIT_EXCEEDED}'"
      multipart_unmatched_boundary: |
        MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" \
        "id:'200004',phase:2,t:none,log,deny,msg:'Multipart parser detected a possible unmatched boundary.'"
      tx_flags: |
        TX:/^MSC_/ "!@streq 0" \
        "id:'200005',phase:2,t:none,deny,msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'
 
